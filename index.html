<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="/Balagoat/manifest.json">
<meta name="theme-color" content="#007bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzap4gRgh9HzevuVwZvombMGxAI45V-MUM5Ny60m4ccRAjNbXHtdgP_AdwGLmiySvaF/exec"; 
    let currentMode = "Positive", currentDept = "", html5QrCode = null, sessionScores = {Bosco:0, Savio:0, Ruva:0, Thomas:0}, studentMeta = {};

    // --- NEW: World Class Feedback (Sound) ---
    const playSuccessSound = () => {
      try {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const osc = context.createOscillator();
        const gain = context.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(880, context.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(context.destination);
        osc.start();
        osc.stop(context.currentTime + 0.1);
      } catch(e) { console.log("Audio feedback error"); }
    };

    async function callAPI(data) {
      const r = await fetch(API_URL, { method: "POST", body: JSON.stringify(data) });
      return await r.json();
    }

    async function initApp() {
      const imgs = await callAPI({action: "getImages"});
      document.body.style.backgroundImage = `url('${imgs.bg}')`;
      document.getElementById('main-logo').src = document.getElementById('cert-logo').src = imgs.logo;
      document.getElementById('main-founder').src = document.getElementById('cert-founder').src = imgs.founder;
      document.getElementById('cert-sig').src = imgs.signature;

      const list = await callAPI({action: "getDeptList"});
      const s = document.getElementById('user-select');
      s.innerHTML = '<option disabled selected>Select Department</option>';
      list.forEach(d => s.add(new Option(d, d)));
    }

    async function login() {
      const u = document.getElementById('user-select').value, p = document.getElementById('pass-input').value;
      const r = await callAPI({action: "authenticate", user: u, pass: p});
      if(r.success) {
        document.getElementById('login-view').style.display='none';
        if(r.role === 'Admin') { document.getElementById('admin-view').style.display='block'; loadAdmin(); } 
        else { document.getElementById('teacher-view').style.display='block'; currentDept = r.dept; }
      } else alert("Invalid Login");
    }

    function setMode(m) { 
      currentMode = m; 
      document.getElementById('btn-pos').style.opacity = m === 'Positive' ? '1' : '0.5'; 
      document.getElementById('btn-neg').style.opacity = m === 'Negative' ? '1' : '0.5';
    }

    async function toggleCamera() {
      const reader = document.getElementById('reader');
      if(reader.style.display === 'none') {
        reader.style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (t) => {
          const p = t.split('|'); 
          if(p.length >= 3) { 
            processEntry(p[0], p[2], p[1]); 
            stopCam(); 
          }
        }).catch(err => console.error(err));
      } else { stopCam(); }
    }
    
    function stopCam() { if(html5QrCode) html5QrCode.stop(); document.getElementById('reader').style.display='none'; }

    async function processEntry(name, house, dept = "") {
      const t = document.getElementById('t-name').value;
      if(!t) return alert("Enter Teacher Name");
      
      // World Class Feedback
      if ("vibrate" in navigator) navigator.vibrate(100);
      playSuccessSound();

      const h = house.charAt(0).toUpperCase() + house.slice(1).toLowerCase();
      const pts = currentMode === 'Positive' ? 10 : -5;
      
      if(sessionScores.hasOwnProperty(h)) {
        sessionScores[h] += pts;
        document.getElementById('s-'+h).innerText = sessionScores[h];
        showToast(`${name}: ${pts} pts`);
        if(pts > 0) confetti({ particleCount: 50, spread: 70, origin: { y: 0.6 } });

        await callAPI({action: "submitPoint", data: { 
          dept: currentDept, studentDept: dept, studentName: name, 
          teacherName: t, category: document.getElementById('p-cat').value, 
          house: h, type: currentMode 
        }});
      }
    }

    async function loadAdmin() {
      const d = await callAPI({action: "getAdminData"});
      studentMeta = d.meta;
      const houseRow = (label, data) => `<div class="rank-row"><span>${label}</span><b>${data[0]} (${data[1]})</b></div>`;
      
      let h = `<h3>ANNUAL HOUSE STANDINGS</h3><div class="stat-card">
        ${houseRow("ðŸ¥‡ WINNER", d.yearlyHouses[0])}${houseRow("ðŸ¥ˆ RUNNER", d.yearlyHouses[1])}${houseRow("ðŸ¥‰ 2ND RUNNER", d.yearlyHouses[2])}
      </div>
      <h3>WEEKLY HOUSE STANDINGS</h3><div class="stat-card">
        ${houseRow("ðŸ¥‡ WINNER", d.weeklyHouses[0])}${houseRow("ðŸ¥ˆ RUNNER", d.weeklyHouses[1])}${houseRow("ðŸ¥‰ 2ND RUNNER", d.weeklyHouses[2])}
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div><h4>ANNUAL TOP 3 DEPT</h4>${renderToppers(d.yearlyDeptToppers, "Annual Topper")}</div>
        <div><h4>WEEKLY TOP 3 DEPT</h4>${renderToppers(d.weeklyDeptToppers, "Weekly Topper")}</div>
      </div>`;
      document.getElementById('admin-content').innerHTML = h;
    }

    function renderToppers(list, type) {
      return list.map(d => `<div class="stat-card" style="font-size:12px;"><b>${d.dept}</b>
        ${d.toppers.map(t => `<div class="rank-row"><span>${t[0]}</span><button class="btn-cert" onclick="genPDF('${t[0]}','${type}','${d.dept}')">CERT</button></div>`).join('')}
      </div>`).join('');
    }

    async function genPDF(n, a, d) {
      const meta = studentMeta[n.toUpperCase()] || {house: "N/A"};
      document.getElementById('pdf-name').innerText = n.toUpperCase();
      document.getElementById('pdf-award').innerText = a;
      document.getElementById('pdf-dept').innerText = d;
      document.getElementById('pdf-house').innerText = meta.house;
      const canvas = await html2canvas(document.getElementById('cert-template'), { scale: 2, useCORS: true });
      const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 297, 210);
      pdf.save(`Cert_${n}.pdf`);
    }

    function showToast(m) { 
      const t = document.getElementById('toast'); 
      t.innerText = m; 
      t.style.display = 'block'; 
      setTimeout(() => t.style.display='none', 2500); 
    }
</script>
  </script>
</body>
</html>
